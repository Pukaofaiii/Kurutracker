{% extends 'base.html' %}

{% block title %}audit report - KURU Tracker{% endblock %}

{% block content %}
<style>
    .stat-bar {
        transition: width 1s ease-out;
    }
</style>

<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-md p-8 border-l-4 border-kuru-blue">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-kuru-brown mb-1">audit report</h1>
                <p class="text-gray-600">comprehensive system inventory analysis and statistics</p>
                <p class="text-gray-500 text-sm mt-2">report period: last {{ days}} days (since {{ start_date|date:"M d, Y" }})</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="?days=7" class="px-4 py-2 rounded-lg font-semibold transition-all {% if days == 7 %}bg-kuru-blue text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    7 days
                </a>
                <a href="?days=30" class="px-4 py-2 rounded-lg font-semibold transition-all {% if days == 30 %}bg-kuru-blue text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    30 days
                </a>
                <a href="?days=90" class="px-4 py-2 rounded-lg font-semibold transition-all {% if days == 90 %}bg-kuru-blue text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    90 days
                </a>
            </div>
        </div>
    </div>

    <!-- Overall Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-md p-6 border-t-4 border-kuru-blue">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-semibold mb-1">total items</p>
                    <p class="text-4xl font-bold text-kuru-brown">{{ total_items }}</p>
                </div>
                <div class="w-16 h-16 bg-kuru-blue/10 rounded-xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-kuru-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                </div>
            </div>
        </div>

        {% for status_label, status_data in status_counts.items %}
        <div class="bg-white rounded-xl shadow-md p-6 border-t-4
            {% if 'Normal' in status_label %}border-kuru-success
            {% elif 'Damaged' in status_label %}border-kuru-yellow
            {% elif 'Repair' in status_label %}border-kuru-orange
            {% elif 'Lost' in status_label %}border-kuru-danger
            {% else %}border-kuru-blue{% endif %}">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-gray-600 text-sm font-semibold mb-1">{{ status_label|lower }}</p>
                    <p class="text-3xl font-bold text-kuru-brown">{{ status_data.count }}</p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center
                    {% if 'Normal' in status_label %}bg-kuru-success/10
                    {% elif 'Damaged' in status_label %}bg-kuru-yellow/10
                    {% elif 'Repair' in status_label %}bg-kuru-orange/10
                    {% elif 'Lost' in status_label %}bg-kuru-danger/10
                    {% else %}bg-kuru-blue/10{% endif %}">
                    <span class="text-xl font-bold
                        {% if 'Normal' in status_label %}text-kuru-success
                        {% elif 'Damaged' in status_label %}text-kuru-yellow
                        {% elif 'Repair' in status_label %}text-kuru-orange
                        {% elif 'Lost' in status_label %}text-kuru-danger
                        {% else %}text-kuru-blue{% endif %}">
                        {{ status_data.percentage|floatformat:0 }}%
                    </span>
                </div>
            </div>
            <div class="bg-gray-200 rounded-full h-2">
                <div class="stat-bar h-2 rounded-full
                    {% if 'Normal' in status_label %}bg-kuru-success
                    {% elif 'Damaged' in status_label %}bg-kuru-yellow
                    {% elif 'Repair' in status_label %}bg-kuru-orange
                    {% elif 'Lost' in status_label %}bg-kuru-danger
                    {% else %}bg-kuru-blue{% endif %}"
                    style="width: {{ status_data.percentage }}%"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Category Statistics -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-kuru-green px-6 py-4 border-b-2 border-kuru-green/20">
                <h2 class="text-xl font-bold text-white">items by category</h2>
            </div>
            <div class="p-6 space-y-3">
                {% for cat in category_stats %}
                <div class="flex items-center justify-between p-4 bg-kuru-beige rounded-lg hover:shadow-md transition-shadow">
                    <div class="flex-1">
                        <p class="font-bold text-kuru-brown">{{ cat.name }}</p>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div class="bg-kuru-green h-2 rounded-full" style="width: {{ cat.percentage }}%"></div>
                        </div>
                    </div>
                    <span class="ml-4 text-2xl font-bold text-kuru-green">{{ cat.item_count }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">no categories found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Room Statistics -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-kuru-orange px-6 py-4 border-b-2 border-kuru-orange/20">
                <h2 class="text-xl font-bold text-white">top rooms (by item count)</h2>
            </div>
            <div class="p-6 space-y-3">
                {% for room in room_stats %}
                <div class="flex items-center justify-between p-4 bg-kuru-beige rounded-lg hover:shadow-md transition-shadow">
                    <div class="flex-1">
                        <p class="font-bold text-kuru-brown">{{ room.room.code }}</p>
                        {% if room.room.description %}
                        <p class="text-sm text-gray-600">{{ room.room.description }}</p>
                        {% endif %}
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                            <div class="bg-kuru-orange h-2 rounded-full" style="width: {{ room.percentage }}%"></div>
                        </div>
                    </div>
                    <span class="ml-4 text-2xl font-bold text-kuru-orange">{{ room.item_count }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">no room data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Owner Statistics -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-kuru-blue px-6 py-4 border-b-2 border-kuru-blue/20">
            <h2 class="text-xl font-bold text-white">top item holders</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% for owner in owner_stats %}
                <div class="p-4 bg-kuru-beige rounded-xl border-2 border-kuru-blue/20 hover:border-kuru-blue transition-all">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-12 h-12 bg-kuru-blue rounded-full flex items-center justify-center text-white font-bold text-lg">
                            {{ owner.owner.email.0|upper }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-kuru-brown truncate text-sm">{{ owner.owner.get_full_name }}</p>
                            <p class="text-xs text-gray-600 truncate">{{ owner.owner.email }}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-3xl font-bold text-kuru-blue">{{ owner.item_count }}</span>
                        <span class="text-sm text-gray-600">items</span>
                    </div>
                </div>
                {% empty %}
                <p class="col-span-4 text-gray-500 text-center py-8">no data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Items Needing Attention -->
    {% if items_needing_attention %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-kuru-danger px-6 py-4 border-b-2 border-kuru-danger/20">
            <h2 class="text-xl font-bold text-white flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                items needing attention
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-kuru-brown">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">asset id</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">name</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">category</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">room</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">owner</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">status</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in items_needing_attention %}
                    <tr class="hover:bg-kuru-beige transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-kuru-brown">
                            <a href="{% url 'items:item_detail' item.pk %}" class="text-kuru-blue hover:text-kuru-blue/80">
                                {{ item.asset_id }}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ item.name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ item.category.name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {% if item.room %}{{ item.room.code }}{% else %}—{% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ item.current_owner.email }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded text-xs font-semibold
                                {% if item.status == 'DAMAGED' %}bg-kuru-yellow/20 text-kuru-yellow
                                {% elif item.status == 'LOST' %}bg-kuru-danger/20 text-kuru-danger
                                {% elif item.status == 'REPAIR' %}bg-kuru-orange/20 text-kuru-orange
                                {% else %}bg-kuru-blue/20 text-kuru-blue{% endif %}">
                                {{ item.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <a href="{% url 'audit:audit_checklist' %}?search={{ item.asset_id }}"
                               class="text-kuru-blue hover:text-kuru-blue/80 font-semibold">
                                review →
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Transfers -->
    {% if recent_transfers %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-kuru-success px-6 py-4 border-b-2 border-kuru-success/20">
            <h2 class="text-xl font-bold text-white">recent transfers (last {{ days }} days)</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-kuru-brown">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">date</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">item</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">from</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">to</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">type</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for transfer in recent_transfers %}
                    <tr class="hover:bg-kuru-beige transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ transfer.transferred_at|date:"M d, Y H:i" }}
                        </td>
                        <td class="px-6 py-4 text-sm font-semibold text-gray-900">
                            <a href="{% url 'items:item_detail' transfer.item.pk %}" class="text-kuru-blue hover:text-kuru-blue/80">
                                {{ transfer.item.asset_id }} - {{ transfer.item.name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ transfer.from_user.email }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ transfer.to_user.email }}</td>
                        <td class="px-6 py-4 text-sm">
                            {% if transfer.is_forced %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-kuru-orange/20 text-kuru-orange">
                                forced
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-kuru-success/20 text-kuru-success">
                                normal
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="flex justify-center">
        <a href="{% url 'audit:audit_checklist' %}"
           class="inline-flex items-center px-8 py-4 bg-kuru-blue text-white rounded-lg font-bold hover:bg-kuru-blue/90 transition-all shadow-md hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            back to audit checklist
        </a>
    </div>
</div>
{% endblock %}
